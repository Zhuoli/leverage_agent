name: Build Mac Application

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-mac:
    name: Build macOS ARM64 Application
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install root dependencies
        run: npm ci

      - name: Install Electron app dependencies
        run: cd electron-app && npm ci

      - name: Build TypeScript
        run: npm run build

      - name: Prepare Electron app backend
        run: cd electron-app && npm run prebuild

      - name: Verify backend files exist
        run: |
          if [ ! -f "electron-app/backend-dist/cli/index.js" ]; then
            echo "ERROR: backend-dist/cli/index.js not found!"
            echo "Contents of electron-app/backend-dist:"
            ls -la electron-app/backend-dist/ || echo "backend-dist directory does not exist"
            exit 1
          fi
          echo "âœ“ Backend files verified"
          ls -lh electron-app/backend-dist/cli/

      - name: Clean previous build artifacts
        run: rm -rf electron-app/dist

      - name: Build macOS ARM64 app
        run: cd electron-app && npm run build:mac
        env:
          # GitHub token for publishing releases (if needed)
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload macOS ARM64 artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-arm64-build
          path: |
            electron-app/dist/*.dmg
            electron-app/dist/*.zip
          retention-days: 7

      - name: List build outputs
        run: ls -lh electron-app/dist/
